---
title: "Identifying Risk Factors and Preferred Hospitals for Hip/Knee Replacements: An Analysis of 2019-2022 Hospital Readmission Reduction Program Data"
subtitle: "Team Iota: Exploratory Data Analysis"
author: "Week Four Team Lead: Adeline Casali |  Week Four Recorder/Spokesperson: Scott Eugley"
date: "2024-07-29"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    fig_crop: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = FALSE,
                      cache.comments = TRUE,
                      size = 13)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# clean, set up, and load
pacman::p_unload(pacman::p_loaded(), character.only = TRUE)
rm(list = ls(all = TRUE))

pacman::p_load(tidyverse, 
               ggplot2, 
               kableExtra, 
               lubridate, 
               caret,
               janitor,
               naniar, 
               maps, 
               psych, 
               reshape2, 
               corrplot, 
               glmnet) 

load("HipKneeClean.Rdata")
```

[GitHub Repository Here](https://github.com/adelinecasali4/hospital-readmission/tree/main)

# Background and Question
### Question  
What are the most significant risk factors associated with hospital readmission rate in hip/knee replacement patients?  

### Hypothesis  
Hospitals with better Hospital Consumer Assessment of Healthcare Providers and Systems (HCAHPS) scores will have lower readmission rates for hip/knee replacements because higher patient satisfaction often correlates with better overall care quality and patient outcomes, including reduced complications and better post-discharge support (Edwards et al., 2015).  

### Prediction  
It is anticipated that patient satisfaction, clinical treatment quality, and operational efficiency will be the most important risk factor categories associated with hospital readmission rates among patients who have had hip or knee replacement surgery. The most important variables influencing readmission rates for patients after hip or knee replacement surgery will most likely be a combination of high HCAHPS scores and reduced rates of clinical complications.  

# Data
We will be using the datasets from the Centers for Medicare and Medicaid Services (Centers for Medicare & Medicaid Services, 2024). To clean the data, we started by loading multiple hospital datasets and standardizing the column names. Next, we addressed missing values by replacing "N/A" and "Too Few to Report" with appropriate values, converting certain columns to numeric types, and removing unnecessary text from measure names. We then created dictionaries for medical conditions, HCAHPS questions, and other metrics, and pivoted the datasets to a wider format for easier analysis. Finally, we joined the cleaned datasets based on FacilityId, removed redundant columns, and filtered out columns with excessive missing values.

# Results

### Summary table for numeric variables
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Select numeric columns
numeric_columns <- select_if(HipKneeClean, is.numeric)

# Calculate descriptive statistics
descr_stats <- psych::describe(numeric_columns)

# Convert to a data frame
descr_stats_df <- as.data.frame(descr_stats)

# Display the table
kable(descr_stats_df, format = "html", caption = "Table 1. Descriptive Statistics for Numeric Variables in Cleaned Dataset") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

> This table provides descriptive statistics for the numeric variables in the dataset. Mean number of readmissions is 8, with a standard deviation of 7.8, which indicates high variability between hospitals. Patient survey star ratings show a low standard deviation, which indicates consistency in patient experience across hospitals. As expected high HCAHPS scores on measures in cleanliness and recommendation is correlated with an overall positive patient experience.  

### Exploring categorical variables
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Visualizing the distribution of EDV (Emergency Department Volume)
ggplot(HipKneeClean, aes(x = EDV)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Figure 1. Distribution of Emergency Department Volume",
       x = "EDV",
       y = "Count") +
  theme_minimal() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

> This histogram illustrates the distribution of Emergency Department Volume  across hospitals. The majority of hospitals are in the “low” category, followed by medium volume, very high volume, and high volume. The remaining hospitals did not have data provided for emergency department volume.  

### Visualizing the number of facilities per state
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Data preparation
facility_counts <- HipKneeClean %>%
  group_by(State) %>%
  summarise(Count = n(), .groups = 'drop')

# Check the first few rows
head(facility_counts)

# Get state boundaries
states_map <- map_data("state")

# Create a mapping from state abbreviations to full state names
state_mapping <- data.frame(
  State = state.abb,
  full_state_name = tolower(state.name),
  stringsAsFactors = FALSE
)

# Add full state names to facility_counts
facility_counts <- merge(facility_counts, state_mapping, by.x = "State", by.y = "State")

# Join facility counts with state map data
facility_map_data <- left_join(states_map, facility_counts, by = c("region" = "full_state_name"))

# Replace NA values with 0 in the Count column
facility_map_data$Count[is.na(facility_map_data$Count)] <- 0

# Plot the map with facility counts
ggplot(data = facility_map_data) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = Count), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", na.value = "grey50", name = "Facility Count") +
  theme_minimal() +
  labs(title = "Figure 2. Number of Facilities per State") +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank())
```

> As illustrated in the map above, California and Texas have the highest number of hospitals by state in this dataset.  

### Visualizing the average PredictedReadmissionRate_HIP-KNEE per state
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Calculate the average PredictedReadmissionRate_HIP-KNEE per state
average_readmission_rate <- HipKneeClean %>%
  group_by(State) %>%
  summarize(Average_PredictedReadmissionRate_HIP_KNEE = mean(PredictedReadmissionRate_HIP_KNEE, na.rm = TRUE))

# Add full state names to the average readmission rate data
average_readmission_rate <- merge(average_readmission_rate, state_mapping, by.x = "State", by.y = "State")

# Join average readmission rate with state map data
readmission_map_data <- left_join(states_map, average_readmission_rate, by = c("region" = "full_state_name"))

# Plot the map with average readmission rates
ggplot(data = readmission_map_data) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = Average_PredictedReadmissionRate_HIP_KNEE), color = "white") +
  scale_fill_gradient(low = "lightgreen", high = "darkgreen", name = "Average Predicted\nReadmission Rate") +
  theme_minimal() +
  labs(title = "Figure 3. Average Predicted Readmission Rate for Hip/Knee Replacement per State") +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank())
```

> The map above indicates that Kentucky and Florida have the highest average predicted readmission rates for hip/knee patients.  

### Visualizing the spread of the target variable (PredictedReadmissionRate_HIP_KNEE)
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Create a histogram of PredictedReadmissionRate_HIP_KNEE
ggplot(HipKneeClean, aes(x = PredictedReadmissionRate_HIP_KNEE)) +
  geom_histogram(binwidth = 0.25, fill = "skyblue", color = "black") +
  labs(title = "Figure 4. Histogram of Predicted Readmission Rate for Hip/Knee Replacement",
       x = "Predicted Readmission Rate",
       y = "Frequency") +
  theme_minimal() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

> The histogram of Predicted Readmission Rate for Hip/Knee Replacement appears to be normally distributed, perhaps with a slight right skew. This indicates that more hospitals sit below the average of predicted readmission rate, but also that a few hospitals have significantly higher predicted readmission rates.  

### Table of missing values
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Calculate missing values
missing_values_summary <- HipKneeClean %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Count") %>%
  mutate(Missing_Percentage = (Missing_Count / nrow(HipKneeClean)) * 100)

# Print the table using kable
missing_values_summary %>%
  kable(caption = "Table 2. Missing Values Summary") %>%
  kable_styling(bootstrap_options = c("hover", "striped", "responsive"))
```

> The table above provides an overview of all missing values in the dataset. There is a significant amount of missing data in the readmission rate, patient survey ratings, and clinical scores variables.  

### Assessing colinearity
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=14, fig.height=12}
# Compute correlation matrix
cor_matrix <- cor(HipKneeClean %>% select_if(is.numeric), use = "pairwise.complete.obs")

# Melt the correlation matrix into a long format
cor_melted <- melt(cor_matrix)

# Plot the heatmap
ggplot(cor_melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), name = "Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Figure 5. Correlation Heatmap of Numeric Variables")

# Convert the correlation matrix to a data frame
cor_table <- as.data.frame(cor_matrix)

# Add variable names as a column for better readability
cor_table$Variable <- rownames(cor_table)

# Reorder columns for better readability
cor_table <- cor_table %>%
  select(Variable, everything())

# Print the table using kable
cor_table %>%
  kable(caption = "Table 3. Correlation Coefficients Table") %>%
  kable_styling(bootstrap_options = c("hover", "striped", "responsive"))
```

> Heatmap of numeric variables used to visualize correlations between variables and possible issues with collinearity. A dark red block in the lower left area of the map indicates possible collinearity issues between the star rating variables and the linear score variables.  

# Discussion and Next Steps  
This exploratory data analysis highlighted the complexity of working with raw data. The biggest takeaway was the high number of missing values as indicated in Table 2, as well as the collinearity problem, as shown in Figure 5 and Table 3. Our target variable, predicted readmission rate, has a relatively normal distribution, but contains 61% NA values (Figure 4). Additionally, there was strong collinearity highlighted between HCAHPS variables, which will have to be addressed (Figure 5). Additionally, we noticed geographic trends in the data with states like Kentucky and Florida having the highest predicted readmission rates (Figure 3).  
Our next steps are dealing with the missing value problem and the colinearity problem. We will need to decide if removing NA values is the best decision, or if it is reliable to impute the data using a method such as KNN. For the collinearity problem, we will need to decide how to prevent the collinearity between HCAHPS variables from causing undue influence on the models, likely through feature engineering and the reduction of variables. We will also be completing a segmentation analysis using the unsupervised method KNN to identify clusters in the data. 
